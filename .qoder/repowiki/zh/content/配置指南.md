# 配置指南

<cite>
**本文档中引用的文件**   
- [server.py](file://src/element_plus_mcp/server.py)
- [server.py](file://src/fs_mcp/server.py)
- [server.py](file://src/knowledge_mcp/server.py)
- [server.py](file://src/mysql_mcp/server.py)
- [server.py](file://src/template_mcp/server.py)
- [pyproject.toml](file://pyproject.toml)
- [README.md](file://README.md)
- [config.py](file://src/mysql_mcp/gen/config.py) - *新增的代码生成配置文件*
- [gen.py](file://src/mysql_mcp/gen/gen.py) - *代码生成器实现文件*
- [types.py](file://src/mysql_mcp/gen/types.py) - *更新的上下文字段定义*
- [cache.py](file://src/common/cache.py) - *新增的缓存模块*
</cite>

## 更新摘要
**变更内容**   
- 新增了**缓存机制配置**章节，详细说明`mysql_mcp`服务中引入的全局缓存实例及其配置
- 在**代码生成配置规范**章节中更新了`VelocityContext`模型的字段说明，反映最新的上下文字段变更
- 在**服务连接参数**章节中补充了`mysql_mcp`服务的缓存相关行为说明
- 更新了**配置示例**章节，添加了缓存配置的建议值
- 增强了源码追踪系统，添加了新文件`cache.py`和更新文件`types.py`的引用

## 目录
1. [配置指南](#配置指南)
2. [环境变量配置规范](#环境变量配置规范)
3. [服务连接参数](#服务连接参数)
4. [服务选项与端口配置](#服务选项与端口配置)
5. [配置示例](#配置示例)
6. [敏感信息安全处理](#敏感信息安全处理)
7. [部署环境调整建议](#部署环境调整建议)
8. [代码生成配置规范](#代码生成配置规范)
9. [缓存机制配置](#缓存机制配置)

## 环境变量配置规范

本项目中的所有MCP服务均通过环境变量进行统一配置，支持从`.env`文件或系统环境变量中读取配置。各服务模块通过`os.getenv()`函数获取环境变量值，并提供默认值以确保服务的可运行性。

### 环境变量加载机制

所有服务模块均实现了统一的环境变量加载机制。当服务启动时，会自动检查项目根目录下的`.env`文件是否存在，如果存在则使用`python-dotenv`库加载其中的环境变量。

```python
# 通用的环境变量加载代码模式
env_file = Path(__file__).parent.parent.parent / ".env"
if env_file.exists():
    from dotenv import load_dotenv
    load_dotenv(env_file)
```

这种设计允许开发者在开发环境中使用`.env`文件管理配置，而在生产环境中直接使用系统环境变量，提高了配置的灵活性和安全性。

### 统一配置原则

各MCP服务遵循以下统一配置原则：
- **前缀命名规范**：不同服务的环境变量使用不同的前缀，避免命名冲突
- **默认值机制**：所有配置项都提供合理的默认值，确保服务在缺少配置时仍能启动
- **类型转换**：对数值型配置项进行显式的类型转换（如`int()`、`float()`）
- **必填项验证**：对关键配置项进行存在性验证，缺少必要配置时抛出明确错误

**Section sources**
- [server.py](file://src/mysql_mcp/server.py#L0-L49)
- [server.py](file://src/fs_mcp/server.py#L49-L84)

## 服务连接参数

不同MCP服务根据其功能需求定义了特定的连接参数，主要通过环境变量进行配置。以下是各服务的连接参数配置规范。

### 文件系统服务 (fs_mcp)

文件系统服务通过环境变量`MCP_ALLOWED_DIRECTORIES`配置允许访问的目录列表，多个目录路径使用分号(`;`)分隔。

```python
# fs_mcp/server.py
env_dirs = os.getenv("MCP_ALLOWED_DIRECTORIES")
if env_dirs:
    env_directories = [d.strip() for d in env_dirs.split(";") if d.strip()]
    directories = tuple(env_directories) + directories
```

当未配置此环境变量时，服务默认允许访问当前工作目录。服务还实现了路径验证机制，防止路径遍历攻击，确保只能访问配置目录及其子目录。

### 数据库服务 (mysql_mcp)

MySQL服务通过以下环境变量配置数据库连接参数：

- `MYSQL_HOST`：数据库主机地址，默认值为`localhost`
- `MYSQL_PORT`：数据库端口，默认值为`3306`
- `MYSQL_USER`：数据库用户名，无默认值，必须配置
- `MYSQL_PASSWORD`：数据库密码，无默认值，必须配置
- `MYSQL_DATABASE`：数据库名称，无默认值，必须配置

服务在启动时会对这些必填项进行验证，缺少任何一项都会抛出`ValueError`异常。

```python
# mysql_mcp/server.py
config = {
    "host": os.getenv("MYSQL_HOST", "localhost"),
    "port": int(os.getenv("MYSQL_PORT", "3306")),
    "user": os.getenv("MYSQL_USER"),
    "password": os.getenv("MYSQL_PASSWORD"),
    "database": os.getenv("MYSQL_DATABASE"),
}
if not all([config["user"], config["password"], config["database"]]):
    raise ValueError("Missing required database configuration")
```

此外，`mysql_mcp`服务还提供了代码生成功能，通过`gen`模块实现。该功能允许根据数据库表结构生成代码模板，支持配置生成参数。服务还引入了缓存机制，对表结构、表列表和模板上下文进行缓存，提高性能。

### 知识库服务 (knowledge_mcp)

知识库服务需要连接PostgreSQL数据库和Ollama服务，其连接参数配置如下：

**PostgreSQL数据库配置**：
- `DB_HOST`：数据库主机地址，默认值为`localhost`
- `DB_PORT`：数据库端口，默认值为`5432`
- `DB_NAME`：数据库名称，默认值为`postgres`
- `DB_USER`：数据库用户名，默认值为`postgres`
- `DB_PASSWORD`：数据库密码，默认值为`1qaz2wsx`

**Ollama服务配置**：
- `OLLAMA_URL`：Ollama服务地址，默认值为`http://localhost:11434`
- `EMBEDDING_MODEL`：使用的embedding模型名称，默认值为`rjmalagon/gte-qwen2-1.5b-instruct-embed-f16`

```python
# knowledge_mcp/server.py
CONFIG = {
    'ollama_url': os.getenv('OLLAMA_URL', 'http://localhost:11434'),
    'model_name': os.getenv('EMBEDDING_MODEL', 'rjmalagon/gte-qwen2-1.5b-instruct-embed-f16'),
    'db_config': {
        'host': os.getenv('DB_HOST', 'localhost'),
        'port': int(os.getenv('DB_PORT', 5432)),
        'dbname': os.getenv('DB_NAME', 'postgres'),
        'user': os.getenv('DB_USER', 'postgres'),
        'password': os.getenv('DB_PASSWORD', '1qaz2wsx')
    },
}
```

### GitHub服务 (element_plus_mcp)

GitHub服务通过环境变量`GITHUB_API_KEY`配置GitHub API密钥，用于访问GitHub仓库。

```python
# element_plus_mcp/github.py
"github_api_key": os.getenv("GITHUB_API_KEY", default)
```

服务从请求头`X-GITHUB-API-KEY`中获取API密钥，建议配置此密钥以避免GitHub API的请求限制。

**Section sources**
- [server.py](file://src/knowledge_mcp/server.py#L31-L43)
- [server.py](file://src/mysql_mcp/server.py#L59-L63)
- [server.py](file://src/fs_mcp/server.py#L73)
- [github.py](file://src/element_plus_mcp/github.py#L9)

## 服务选项与端口配置

除了连接参数外，各MCP服务还支持多种服务选项配置，包括端口、传输协议等。

### 端口配置

不同MCP服务使用不同的默认端口：

- `fs_mcp`：默认端口未在代码中显式指定，但文档中提到默认网络通信接口为3005
- `knowledge_mcp`：默认端口为3002
- `element_plus_mcp`：默认端口为3003
- `template_mcp`：默认端口为3005

端口可以通过命令行参数`--port`进行覆盖：

```python
# knowledge_mcp/server.py
@click.option("--port", type=int, default=3002, help="Port to listen on")
def main(transport: str, port: int):
    # ... 启动服务器时使用指定端口
    uvicorn.run(starlette_app, host="0.0.0.0", port=port)
```

### 传输协议配置

所有MCP服务支持三种传输协议：
- `stdio`：标准输入输出，适用于本地集成
- `sse`：Server-Sent Events，适用于HTTP流式传输
- `streamable`：可流式HTTP协议

传输协议可以通过命令行参数`--transport`进行配置，默认为`stdio`。

```python
# 通用的传输协议处理逻辑
if transport == "sse":
    run_server(mcp.sse_app())
elif transport == "streamable":
    run_server(mcp.streamable_http_app())
else:
    mcp.run(transport="stdio")
```

### 其他服务选项

**知识库服务特殊配置**：
- `TOP_K`：返回最相似的前K个结果，默认值为5
- `SIMILARITY_THRESHOLD`：相似度阈值，默认值为0.3
- `DB_SCHEMA`：数据库模式名，默认值为`code_gen`
- `DB_TABLE`：存储向量的表名，默认值为`open_ai_embeddings`

**文件系统服务特殊配置**：
- 通过`initialize_allowed_directories()`函数支持在代码中直接指定允许访问的目录

**Section sources**
- [server.py](file://src/knowledge_mcp/server.py#L42-L43)
- [server.py](file://src/knowledge_mcp/server.py#L338-L360)
- [README.md](file://README.md#L118-L125)

## 配置示例

### .env文件示例

```env
# MySQL数据库配置
MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_USER=myuser
MYSQL_PASSWORD=mypassword
MYSQL_DATABASE=mydatabase

# PostgreSQL数据库配置
DB_HOST=localhost
DB_PORT=5432
DB_NAME=knowledge_db
DB_USER=knowledge_user
DB_PASSWORD=securepassword
DB_SCHEMA=public
DB_TABLE=embeddings

# Ollama服务配置
OLLAMA_URL=http://localhost:11434
EMBEDDING_MODEL=rjmalagon/gte-qwen2-1.5b-instruct-embed-f16

# 文件系统服务配置
MCP_ALLOWED_DIRECTORIES=D:\projects;E:\data

# GitHub服务配置
GITHUB_API_KEY=your_github_token_here

# 知识库服务配置
TOP_K=10
SIMILARITY_THRESHOLD=0.4

# 缓存配置
CACHE_TTL=300
```

### 命令行启动示例

```bash
# 启动MySQL MCP服务
uv run mysql_mcp --transport streamable --port 3001

# 启动知识库MCP服务
uv run knowledge_mcp --transport streamable --port 3002

# 启动文件系统MCP服务
uv run fs_mcp --transport streamable --port 3005

# 启动Element Plus MCP服务
uv run element_plus_mcp --transport streamable --port 3003

# 启动模板MCP服务
uv run template_mcp --transport streamable --port 3004
```

### Trae客户端配置示例

```json
{
  "mcpServers": {
    "FileSystem": {
      "url": "http://localhost:3005/mcp",
      "headers": {
        "X-API-KEY": "your-api-key"
      }
    },
    "KnowledgeBase": {
      "url": "http://localhost:3002/mcp",
      "headers": {
        "X-API-KEY": "your-api-key"
      }
    },
    "MySQL": {
      "url": "http://localhost:3001/mcp",
      "headers": {
        "X-API-KEY": "your-api-key"
      }
    }
  }
}
```

### Docker环境变量配置示例

```dockerfile
# Dockerfile
FROM python:3.13

COPY . /app
WORKDIR /app

RUN pip install -e .

ENV MYSQL_HOST=mysql-server
ENV MYSQL_PORT=3306
ENV MYSQL_USER=myuser
ENV MYSQL_PASSWORD=mypassword
ENV MYSQL_DATABASE=mydatabase
ENV MCP_ALLOWED_DIRECTORIES=/app/data;/app/config
ENV CACHE_TTL=300

CMD ["uv", "run", "mysql_mcp", "--transport", "streamable", "--port", "3001"]
```

**Section sources**
- [server.py](file://src/knowledge_mcp/server.py#L338-L360)
- [README.md](file://README.md#L118-L125)

## 敏感信息安全处理

### 推荐的安全实践

1. **使用环境变量而非硬编码**：所有敏感信息（如密码、API密钥）应通过环境变量配置，避免在代码中硬编码
2. **.env文件不应提交到版本控制**：在`.gitignore`中添加`.env`文件，防止敏感信息泄露
3. **使用强密码和密钥**：数据库密码和API密钥应使用足够长度和复杂度的随机字符串
4. **最小权限原则**：数据库用户应仅具有执行必要操作的最小权限
5. **定期轮换密钥**：定期更换API密钥和密码，降低泄露风险

### 文件系统服务安全特性

文件系统服务内置了多项安全机制：

- **目录限制**：只能访问环境变量`MCP_ALLOWED_DIRECTORIES`中指定的目录
- **路径验证**：所有路径都会进行安全验证，防止路径遍历攻击
- **权限检查**：操作前会检查文件/目录的读写权限
- **错误处理**：提供详细的错误信息，便于调试但不泄露系统敏感信息

```python
# 路径验证函数
def validate_path(path: str) -> str:
    abs_path = os.path.abspath(path)
    for allowed_dir in ALLOWED_DIRECTORIES:
        norm_abs_path = os.path.normpath(abs_path).lower()
        norm_allowed_dir = os.path.normpath(allowed_dir).lower()
        common_path = os.path.commonpath([norm_abs_path, norm_allowed_dir])
        if common_path == norm_allowed_dir:
            return abs_path
    raise PermissionError(f"Access denied: Path '{path}' is outside allowed directories")
```

### 生产环境安全建议

1. **限制CORS策略**：将`allow_origins=["*"]`修改为具体的域名列表
2. **使用HTTPS**：在生产环境中使用HTTPS加密通信
3. **配置防火墙**：限制只有必要的IP地址可以访问服务端口
4. **日志审计**：定期审查日志文件，监控异常访问行为
5. **容器化部署**：使用Docker等容器技术隔离服务，限制系统权限

**Section sources**
- [server.py](file://src/fs_mcp/server.py#L49-L84)
- [README.md](file://src/fs_mcp/README.md#L88-L94)

## 部署环境调整建议

### 开发环境配置

在开发环境中，建议使用`.env`文件管理配置，便于团队成员共享配置：

```env
# 开发环境配置
MYSQL_HOST=localhost
MYSQL_USER=dev_user
MYSQL_PASSWORD=dev_password
MYSQL_DATABASE=dev_database
DB_HOST=localhost
DB_USER=dev_user
DB_PASSWORD=dev_password
MCP_ALLOWED_DIRECTORIES=./test_data;./samples
CACHE_TTL=300
```

### 测试环境配置

测试环境应尽可能模拟生产环境，但使用独立的测试数据库：

```env
# 测试环境配置
MYSQL_HOST=test-db.example.com
MYSQL_USER=test_user
MYSQL_PASSWORD=strong_test_password
MYSQL_DATABASE=test_database
DB_HOST=test-pg.example.com
DB_USER=test_user
DB_PASSWORD=strong_test_password
MCP_ALLOWED_DIRECTORIES=/var/test/data
CACHE_TTL=600
```

### 生产环境配置

生产环境应遵循最高安全标准：

1. **使用环境变量而非文件**：通过CI/CD系统或容器编排平台注入环境变量
2. **禁用调试信息**：设置日志级别为`WARNING`或`ERROR`
3. **限制访问源**：配置具体的`allow_origins`而非使用通配符
4. **使用专用用户**：为每个服务创建专用的数据库用户，仅授予必要权限
5. **监控和告警**：配置服务健康检查和异常访问告警

### 不同部署场景的配置调整

**本地开发场景**：
- 使用默认端口
- 可以使用`localhost`作为数据库主机
- 可以使用简单的测试密码
- 启用详细日志记录

**云服务器部署**：
- 使用安全组限制端口访问
- 配置域名和SSL证书
- 使用云数据库服务
- 配置云监控和日志服务

**容器化部署**：
- 通过Docker Secrets或Kubernetes Secrets管理敏感信息
- 使用环境变量注入配置
- 配置适当的资源限制和健康检查
- 使用持久化存储卷管理数据

**Section sources**
- [README.md](file://README.md#L0-L79)
- [server.py](file://src/knowledge_mcp/server.py#L338-L360)
- [server.py](file://src/template_mcp/server.py#L450-L466)

## 代码生成配置规范

`mysql_mcp`服务新增了代码生成功能，通过`gen`模块实现模板上下文工具。该功能允许根据数据库表结构生成代码模板，支持多种配置选项。

### 代码生成配置文件

代码生成器的配置定义在`src/mysql_mcp/gen/config.py`文件中，通过`GEN_CONFIG`字典进行配置：

```python
# 生成配置，等同于原yaml配置
GEN_CONFIG = {
  # 作者
  "author": "jkr",
  # 默认生成包路径 system 需改成自己的模块名称 如 system monitor tool
  "packageName": "com.jkr.project.system",
  # 自动去除表前缀，默认是true
  "autoRemovePre": False,
  # 表前缀（生成类名不会包含表前缀，多个用逗号分隔）
  "tablePrefix": "sys_",
  # 是否允许生成文件覆盖到本地（自定义路径），默认不允许
  "allowOverwrite": False,
}
```

### 配置项说明

**作者配置**：
- `author`：生成代码时的作者信息，默认值为`jkr`

**包路径配置**：
- `packageName`：生成代码的默认包路径，需要根据实际项目修改，如`com.jkr.project.system`

**表前缀处理配置**：
- `autoRemovePre`：是否自动去除表前缀，默认值为`False`
- `tablePrefix`：表前缀配置，生成类名时不会包含表前缀，支持多个前缀用逗号分隔，默认值为`sys_`

**文件覆盖配置**：
- `allowOverwrite`：是否允许生成的文件覆盖到本地（自定义路径），默认值为`False`，不允许覆盖

### 配置使用方式

代码生成器在`gen.py`文件中使用`GEN_CONFIG`配置：

```python
# gen.py
from mysql_mcp.gen.config import GEN_CONFIG

def select_table_by_name(config: MysqlDatabaseConfig, table_name: str) -> Optional[GenTable]:
    # ... 其他代码
    gen_table = GenTable(
        # ... 其他字段
        packageName=GEN_CONFIG["packageName"],  # 使用配置中的包名
        functionAuthor=GEN_CONFIG["author"],    # 使用配置中的作者
        # ... 其他字段
    )
    # ... 其他代码
```

### 代码生成流程

1. **读取数据库表信息**：通过`select_table_by_name`函数查询数据库表的基本信息
2. **读取表列信息**：通过`_select_table_columns_by_name`函数查询表的列信息
3. **转换表名为类名**：通过`_convert_class_name`函数将表名转换为类名，支持去除表前缀
4. **生成代码模板**：结合数据库信息和配置参数生成代码模板

### 代码生成配置示例

在`.env`文件中可以添加代码生成相关的配置说明：

```env
# MySQL数据库配置
MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_USER=myuser
MYSQL_PASSWORD=mypassword
MYSQL_DATABASE=mydatabase

# 代码生成配置（在config.py中定义，此处仅为说明）
# author=jkr
# packageName=com.jkr.project.system
# autoRemovePre=False
# tablePrefix=sys_
# allowOverwrite=False
```

**Section sources**
- [config.py](file://src/mysql_mcp/gen/config.py#L1-L12) - *新增的代码生成配置文件*
- [gen.py](file://src/mysql_mcp/gen/gen.py#L1-L328) - *代码生成器实现文件*
- [server.py](file://src/mysql_mcp/server.py#L194-L198) - *prepare_template_content工具函数定义*

## 缓存机制配置

`mysql_mcp`服务引入了全局缓存机制，用于提升频繁访问数据的性能。缓存功能由`common/cache.py`模块提供，并在`mysql_mcp/server.py`中实例化为全局变量。

### 缓存模块实现

缓存模块`Cache`类定义在`src/common/cache.py`中，采用内存存储和时间戳过期机制：

```python
# src/common/cache.py
class Cache:
    def __init__(self, ttl: int = 300):  # 默认缓存5分钟
        self._cache: Dict[str, Dict[str, Any]] = {}
        self._ttl = ttl

    def get(self, key: str) -> Optional[Any]:
        if key in self._cache:
            data = self._cache[key]
            if time.time() - data["timestamp"] < self._ttl:
                return data["value"]
            else:
                del self._cache[key]
        return None

    def set(self, key: str, value: Any) -> None:
        self._cache[key] = {"value": value, "timestamp": time.time()}
```

### 缓存应用场景

`mysql_mcp`服务在以下场景中使用缓存：

**表结构缓存**：
- 缓存键：`table_structure_{database}_{table_name}`
- 缓存内容：`SHOW FULL COLUMNS FROM {table}`查询结果
- 缓存工具：`describe_table`工具函数

**表列表缓存**：
- 缓存键：`tables_{database}`
- 缓存内容：`information_schema.TABLES`查询结果
- 缓存工具：`list_tables`工具函数

**模板上下文缓存**：
- 缓存键：`{table_name}`
- 缓存内容：`VelocityContext`对象
- 缓存工具：`prepare_template_context`工具函数

### 缓存配置

缓存的生存时间（TTL）通过环境变量`CACHE_TTL`配置，单位为秒。未配置时使用默认值300秒（5分钟）。

```python
# 缓存实例化
cache = Cache(ttl=int(os.getenv("CACHE_TTL", "300")))
```

### 缓存行为说明

- **读取行为**：每次访问缓存数据时，先检查是否存在且未过期，若满足条件则直接返回缓存数据
- **写入行为**：每次生成新数据后，立即将其存入缓存
- **过期机制**：基于时间戳的被动过期，过期数据在下次访问时被清理
- **内存管理**：所有缓存数据存储在内存中，服务重启后缓存清空

### 缓存配置建议

**开发环境**：
- 建议设置较短的TTL（如60秒），便于快速看到数据库结构变更
- 可通过重启服务清空缓存

**生产环境**：
- 建议设置较长的TTL（如600秒），减少数据库查询压力
- 监控内存使用情况，避免缓存占用过多内存

**Section sources**
- [cache.py](file://src/common/cache.py#L1-L25) - *新增的缓存模块*
- [server.py](file://src/mysql_mcp/server.py#L25-L26) - *全局缓存实例化*
- [server.py](file://src/mysql_mcp/server.py#L108-L111) - *表结构缓存使用*
- [server.py](file://src/mysql_mcp/server.py#L165-L168) - *表列表缓存使用*
- [server.py](file://src/mysql_mcp/server.py#L205-L208) - *模板上下文缓存使用*