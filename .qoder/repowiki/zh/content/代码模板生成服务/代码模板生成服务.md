# 代码模板生成服务

<cite>
**本文档中引用的文件**   
- [server.py](file://src\template_mcp\server.py) - *更新了模板服务功能*
- [README.md](file://src\template_mcp\README.md) - *项目基本介绍和使用说明*
- [domain.java.vm](file://src\template_mcp\template\java\domain.java.vm) - *Java实体类模板*
- [index.vue.vm](file://src\template_mcp\template\vue\v3\index.vue.vm) - *Vue3页面组件模板*
- [sql.vm](file://src\template_mcp\template\sql\sql.vm) - *SQL脚本模板*
- [template/](file://src\template_mcp\template/) - *模板文件目录*
- [sample/](file://src\template_mcp\sample/) - *示例文件目录*
</cite>

## 更新摘要
**变更内容**   
- 更新了模板加载、变量替换和代码生成的核心逻辑说明
- 补充了模板语法（.vm）的处理机制
- 增加了如何扩展自定义模板的指导
- 更新了API请求实例
- 优化了模板目录结构分析

## 目录
1. [项目结构](#项目结构)
2. [核心组件](#核心组件)
3. [架构概述](#架构概述)
4. [详细组件分析](#详细组件分析)
5. [依赖分析](#依赖分析)
6. [性能考虑](#性能考虑)
7. [故障排除指南](#故障排除指南)
8. [结论](#结论)

## 项目结构
代码模板生成服务（template_mcp）是一个基于MCP（Model Context Protocol）协议的模板服务器，用于管理和提供代码生成模板文件。项目结构清晰，主要包含模板文件、示例文件和服务器逻辑三大部分。

``mermaid
graph TD
subgraph "template_mcp模块"
A[server.py] --> B[template/]
A --> C[sample/]
A --> D[README.md]
B --> E[java/]
B --> F[js/]
B --> G[sql/]
B --> H[vue/]
B --> I[xml/]
E --> J[domain.java.vm]
E --> K[controller.java.vm]
F --> L[api.js.vm]
G --> M[sql.vm]
H --> N[index.vue.vm]
H --> O[Form.vue.vm]
I --> P[mapper.xml.vm]
C --> Q[java/]
C --> R[js/]
C --> S[vue/]
C --> T[xml/]
Q --> U[domain.java]
Q --> V[controller.java]
R --> W[api.js]
S --> X[index.vue]
S --> Y[Form.vue]
T --> Z[mapper.xml]
end
```

**图示来源**
- [server.py](file://src\template_mcp\server.py)
- [template/](file://src\template_mcp\template/)
- [sample/](file://src\template_mcp\sample/)

**本节来源**
- [server.py](file://src\template_mcp\server.py)
- [README.md](file://src\template_mcp\README.md)

## 核心组件
代码模板生成服务的核心组件包括模板加载、变量替换和代码生成三大功能。服务通过`server.py`文件中的API端点提供这些功能，支持多种编程语言和框架的模板生成。

**本节来源**
- [server.py](file://src\template_mcp\server.py)

## 架构概述
代码模板生成服务采用模块化架构，主要由API接口层、业务逻辑层和数据存储层组成。API接口层提供MCP协议支持，业务逻辑层处理模板加载和变量替换，数据存储层管理模板文件和示例文件。

``mermaid
graph TB
subgraph "API接口层"
A[list_templates]
B[get_template_content]
C[get_sample_content]
D[list_template_categories]
end
subgraph "业务逻辑层"
E[validate_template_name]
F[get_template_file_path]
G[read_template_content]
H[get_sample_file_path]
I[read_sample_content]
end
subgraph "数据存储层"
J[template/]
K[sample/]
end
A --> E
B --> E
C --> E
D --> E
E --> F
F --> G
G --> J
E --> H
H --> I
I --> K
```

**图示来源**
- [server.py](file://src\template_mcp\server.py)

**本节来源**
- [server.py](file://src\template_mcp\server.py)

## 详细组件分析
### 模板加载与变量替换分析
代码模板生成服务的核心功能是模板加载和变量替换。服务使用Velocity模板引擎（.vm文件）来定义模板，通过API请求中的参数替换模板中的变量，生成最终的代码文件。

``mermaid
sequenceDiagram
participant Client as "客户端"
participant Server as "模板服务器"
participant Template as "模板文件"
Client->>Server : 调用get_template_content(template_name)
Server->>Server : validate_template_name(template_name)
alt 模板名称有效
Server->>Server : get_template_file_path(template_name)
Server->>Template : 读取模板文件
Template-->>Server : 返回模板内容
Server->>Server : 构建返回信息
Server-->>Client : 返回格式化的模板内容
else 模板名称无效
Server-->>Client : 返回错误信息和可用模板列表
end
```

**图示来源**
- [server.py](file://src\template_mcp\server.py#L252-L308)
- [server.py](file://src\template_mcp\server.py#L109-L118)
- [server.py](file://src\template_mcp\server.py#L121-L134)
- [server.py](file://src\template_mcp\server.py#L137-L156)

**本节来源**
- [server.py](file://src\template_mcp\server.py)

### 模板目录结构分析
模板目录（template/）按照编程语言和技术栈进行组织，包含Java、JavaScript、Vue、SQL和XML等各类模板文件。每个模板文件都是一个Velocity模板（.vm文件），包含可替换的变量和条件逻辑。

``mermaid
graph TD
A[template/] --> B[java/]
A --> C[js/]
A --> D[sql/]
A --> E[vue/]
A --> F[xml/]
B --> G[domain.java.vm]
B --> H[controller.java.vm]
B --> I[mapper.java.vm]
B --> J[service.java.vm]
B --> K[serviceImpl.java.vm]
B --> L[sub-domain.java.vm]
C --> M[api.js.vm]
D --> N[sql.vm]
E --> O[index.vue.vm]
E --> P[index-tree.vue.vm]
E --> Q[Form.vue.vm]
E --> R[v3/]
R --> S[Form.vue.vm]
R --> T[index-tree.vue.vm]
R --> U[index.vue.vm]
F --> V[mapper.xml.vm]
```

**图示来源**
- [template/](file://src\template_mcp\template/)

**本节来源**
- [template/](file://src\template_mcp\template/)
- [README.md](file://src\template_mcp\README.md)

### API请求实例分析
通过API请求生成不同语言代码的实例展示了服务的使用方法。用户可以通过调用`get_template_content`工具，传入不同的模板名称来获取对应的模板文件内容。

``mermaid
flowchart TD
Start([开始]) --> A[调用get_template_content]
A --> B{模板名称}
B --> |domain| C[读取domain.java.vm]
B --> |controller| D[读取controller.java.vm]
B --> |api| E[读取api.js.vm]
B --> |vue_v3_index| F[读取index.vue.vm]
B --> |sql| G[读取sql.vm]
C --> H[返回Java实体类模板]
D --> I[返回Java控制器模板]
E --> J[返回JavaScript API模板]
F --> K[返回Vue3页面模板]
G --> L[返回SQL脚本模板]
H --> End([结束])
I --> End
J --> End
K --> End
L --> End
```

**图示来源**
- [server.py](file://src\template_mcp\server.py#L252-L308)
- [template/](file://src\template_mcp\template/)

**本节来源**
- [server.py](file://src\template_mcp\server.py)
- [template/](file://src\template_mcp\template/)

## 依赖分析
代码模板生成服务的依赖关系清晰，主要依赖MCP协议框架、Click命令行工具、Pydantic数据验证库和Starlette CORS中间件。这些依赖项共同支持服务的API功能、命令行接口、数据验证和跨域请求处理。

``mermaid
graph TD
A[template_mcp] --> B[mcp]
A --> C[click]
A --> D[pydantic]
A --> E[starlette]
A --> F[pathlib]
A --> G[logging]
B --> G[mcp.server.fastmcp]
B --> H[mcp.types]
C --> I[click.command]
C --> J[click.option]
D --> K[pydantic.Field]
E --> L[starlette.middleware.cors]
```

**图示来源**
- [server.py](file://src\template_mcp\server.py)

**本节来源**
- [server.py](file://src\template_mcp\server.py)
- [README.md](file://src\template_mcp\README.md)

## 性能考虑
代码模板生成服务在性能方面考虑了文件读取效率和错误处理机制。服务使用缓存机制避免重复读取文件，同时提供详细的错误日志帮助调试。对于大量模板请求，建议使用HTTP或SSE传输方式以提高性能。

**本节来源**
- [server.py](file://src\template_mcp\server.py)

## 故障排除指南
当遇到模板生成问题时，可以按照以下步骤进行排查：
1. 检查模板名称是否正确，参考`list_templates`返回的可用模板列表
2. 确认模板文件是否存在，检查`template/`目录下的对应文件
3. 查看服务日志，获取详细的错误信息
4. 验证API请求参数是否符合要求

**本节来源**
- [server.py](file://src\template_mcp\server.py)
- [README.md](file://src\template_mcp\README.md)

## 结论
代码模板生成服务提供了一个高效、灵活的代码生成解决方案。通过清晰的目录结构、丰富的模板类型和简单的API接口，开发者可以快速生成各种编程语言的代码文件。服务的模块化设计和完善的错误处理机制确保了其稳定性和易用性。